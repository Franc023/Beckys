<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Beckys Florister√≠a</title>
    <link rel="stylesheet" href="dashcss.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üå∏ Beckys Florister√≠a</h1>
            <p>Panel de Administraci√≥n</p>
        </div>

        <!-- Navigation Links -->
        <div class="nav-links">
            <a href="crearProducto.html" class="nav-link">‚ûï Crear Producto</a>
            <a href="register.html" class="nav-link">üë§ Registrar Usuario</a>
            <a href="/login" class="nav-link">üîê Iniciar Sesi√≥n</a>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">-</div>
                <div class="stat-label">Total Productos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="inStockProducts">-</div>
                <div class="stat-label">En Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockProducts">-</div>
                <div class="stat-label">Stock Bajo</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Products Section -->
            <div class="products-section">
                <div class="section-header">
                    <h2 class="section-title">üå∫ Productos Disponibles</h2>
                    <div class="search-controls">
                        <input type="text" id="searchInput" placeholder="Buscar productos..." class="search-input">
                        <button onclick="searchProducts()" class="btn-search">Buscar</button>
                        <button onclick="loadProducts()" class="btn-search">Recargar</button>
                    </div>
                </div>
                
                <div id="productsContainer">
                    <div class="loading">Cargando productos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar producto -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Producto</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    
                    <div class="form-group">
                        <label for="editName">üå∏ Nombre:</label>
                        <input type="text" id="editName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDescription">üìù Descripci√≥n:</label>
                        <textarea id="editDescription" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPrice">üí∞ Precio:</label>
                        <input type="number" id="editPrice" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editStock">üì¶ Stock:</label>
                        <input type="number" id="editStock" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editSeason">üçÉ Temporada:</label>
                        <select id="editSeason" required>
                            <option value="">Seleccionar temporada</option>
                            <option value="PRIMAVERA">Primavera</option>
                            <option value="VERANO">Verano</option>
                            <option value="OTO√ëO">Oto√±o</option>
                            <option value="INVIERNO">Invierno</option>
                            <option value="TODO_EL_A√ëO">Todo el a√±o</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editImgUrl">üñºÔ∏è URL de Imagen:</label>
                        <input type="url" id="editImgUrl">
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" onclick="closeEditModal()" class="btn-cancel">Cancelar</button>
                        <button type="submit" class="btn-save">üíæ Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];

        // Cargar productos al iniciar la p√°gina
        window.onload = function() {
            loadProducts();
        };

        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '<div class="loading">Cargando productos...</div>';

            try {
                console.log('Loading products from API...');
                const response = await fetch('/product/v1/allproduct');
                
                if (!response.ok) {
                    throw new Error('Error al cargar productos');
                }

                const products = await response.json();
                console.log('Loaded products:', products);
                
                // Verificar que los productos tienen IDs v√°lidos
                products.forEach(product => {
                    if (!product.id) {
                        console.warn('Product without ID found:', product);
                    }
                });
                
                allProducts = products;
                displayProducts(products);
                updateStats(products);

            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> No se pudieron cargar los productos. 
                        ${error.message}
                    </div>
                `;
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üå∏</div>
                        <h3>No hay productos disponibles</h3>
                        <p>Comienza agregando algunos productos a tu inventario.</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'products-grid';

            products.forEach(product => {
                const card = createProductCard(product);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // Debug: verificar que el producto tiene ID
            console.log('Creating card for product:', product);

            const stockClass = getStockClass(product.stock);
            const stockText = getStockText(product.stock);

            card.innerHTML = `
                <div class="product-image">
                    ${product.imgUrl ? 
                        `<img src="${product.imgUrl}" alt="${product.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='Sin imagen';">` : 
                        'Sin imagen'
                    }
                </div>
                <div class="product-info">
                    <div class="product-name">${escapeHtml(product.name || 'Sin nombre')}</div>
                    <div class="product-description">${escapeHtml(product.description || 'Sin descripci√≥n')}</div>
                    ${product.season ? `<div style="color: #888; font-size: 0.8rem; margin-bottom: 8px;">Temporada: ${escapeHtml(product.season)}</div>` : ''}
                    <div class="product-details">
                        <span class="product-price">$${formatPrice(product.price)}</span>
                        <span class="product-stock ${stockClass}">${stockText}</span>
                    </div>
                    <div class="product-actions">
                        <button class="btn-edit" data-product-id="${product.id}">‚úèÔ∏è Editar</button>
                        <button class="btn-delete" data-product-id="${product.id}">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;

            // Agregar event listeners a los botones
            const editBtn = card.querySelector('.btn-edit');
            const deleteBtn = card.querySelector('.btn-delete');
            
            editBtn.addEventListener('click', () => editProduct(product.id));
            deleteBtn.addEventListener('click', () => deleteProduct(product.id));

            return card;
        }

        function getStockClass(stock) {
            if (!stock || stock === 0) return 'out';
            if (stock <= 5) return 'low';
            return '';
        }

        function getStockText(stock) {
            if (!stock || stock === 0) return 'Agotado';
            if (stock <= 5) return `Quedan ${stock}`;
            return `Stock: ${stock}`;
        }

        function formatPrice(price) {
            if (!price) return '0.00';
            return parseFloat(price).toFixed(2);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStats(products) {
            const total = products.length;
            const inStock = products.filter(p => p.stock > 5).length;
            const lowStock = products.filter(p => p.stock > 0 && p.stock <= 5).length;

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('inStockProducts').textContent = inStock;
            document.getElementById('lowStockProducts').textContent = lowStock;
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayProducts(allProducts);
                return;
            }

            const filteredProducts = allProducts.filter(product => 
                (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                (product.season && product.season.toLowerCase().includes(searchTerm))
            );

            displayProducts(filteredProducts);
        }

        // Permitir buscar con Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // Funciones para editar productos
        async function editProduct(productId) {
            console.log('Edit product called with ID:', productId);
            
            if (!productId) {
                alert('Error: ID de producto no v√°lido');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                alert('Producto no encontrado con ID: ' + productId);
                console.log('Available products:', allProducts);
                return;
            }

            console.log('Found product for editing:', product);

            // Llenar el formulario con los datos del producto
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editName').value = product.name || '';
            document.getElementById('editDescription').value = product.description || '';
            document.getElementById('editPrice').value = product.price || '';
            document.getElementById('editStock').value = product.stock || '';
            document.getElementById('editSeason').value = product.season || '';
            document.getElementById('editImgUrl').value = product.imgUrl || '';

            // Mostrar el modal
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Manejar el formulario de edici√≥n
        document.getElementById('editProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const productId = document.getElementById('editProductId').value;
            console.log('Submitting edit form for product ID:', productId);
            
            if (!productId) {
                alert('Error: ID de producto no v√°lido');
                return;
            }
            
            const updatedProduct = {
                id: parseInt(productId),
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                price: parseFloat(document.getElementById('editPrice').value),
                stock: parseInt(document.getElementById('editStock').value),
                season: document.getElementById('editSeason').value,
                imgUrl: document.getElementById('editImgUrl').value
            };

            console.log('Updated product data:', updatedProduct);

            try {
                console.log('Sending PUT request to update product...');
                const response = await fetch('/product/v1/editproducts', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedProduct)
                });

                console.log('Update response status:', response.status);

                if (response.ok) {
                    const result = await response.text();
                    console.log('Update response:', result);
                    alert('Producto actualizado exitosamente');
                    closeEditModal();
                    loadProducts(); // Recargar productos
                } else {
                    const errorText = await response.text();
                    console.error('Update error response:', errorText);
                    alert('Error al actualizar producto: ' + errorText);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Error al actualizar producto: ' + error.message);
            }
        });

        // Funci√≥n para eliminar producto
        async function deleteProduct(productId) {
            console.log('Delete product called with ID:', productId);
            
            if (!productId) {
                alert('Error: ID de producto no v√°lido');
                return;
            }
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                alert('Producto no encontrado con ID: ' + productId);
                console.log('Available products:', allProducts);
                return;
            }

            console.log('Found product for deletion:', product);

            const confirmDelete = confirm(`¬øEst√°s seguro de que quieres eliminar el producto "${product.name}"?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmDelete) {
                return;
            }

            try {
                console.log('Sending DELETE request for product ID:', productId);
                const response = await fetch(`/product/v1/deletid/${productId}`, {
                    method: 'DELETE'
                });

                console.log('Delete response status:', response.status);

                if (response.ok) {
                    alert('Producto eliminado exitosamente');
                    loadProducts(); // Recargar productos
                } else {
                    const errorText = await response.text();
                    console.error('Delete error response:', errorText);
                    alert('Error al eliminar producto: ' + errorText);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error al eliminar producto: ' + error.message);
            }
        }

        // Cerrar modal al hacer click fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
